name: Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      CONFIG: Release
      BUILD_SERVER: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive   # penting untuk omp-sdk

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update

          # Linux toolchain
          sudo apt-get install -y \
            clang \
            ninja-build \
            cmake \
            gcc-multilib \
            g++-multilib \
            libc6:i386 \
            libstdc++6:i386

          # Windows (mingw-w64) â€“ i686 = 32-bit
          sudo apt-get install -y \
            mingw-w64 \
            binutils-mingw-w64-i686 \
            gcc-mingw-w64-i686 \
            g++-mingw-w64-i686

      #########################################
      # LINUX 32-BIT BUILD
      #########################################
      - name: Configure Linux (32-bit)
        run: |
          cmake -S . -B build-linux32 \
            -G Ninja \
            -DCMAKE_C_FLAGS="-m32" \
            -DCMAKE_CXX_FLAGS="-m32" \
            -DCMAKE_BUILD_TYPE=$CONFIG \
            -DSTATIC_STDCXX=true \
            -DBUILD_SERVER=$BUILD_SERVER

      - name: Build Linux (32-bit)
        run: cmake --build build-linux32 --parallel

      #########################################
      # WINDOWS 32-BIT BUILD
      #########################################
      - name: Configure Windows (32-bit)
        run: |
          cmake -S . -B build-win32 \
            -G Ninja \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=i686-w64-mingw32-gcc \
            -DCMAKE_CXX_COMPILER=i686-w64-mingw32-g++ \
            -DCMAKE_RC_COMPILER=i686-w64-mingw32-windres \
            -DCMAKE_BUILD_TYPE=$CONFIG \
            -DSTATIC_STDCXX=true \
            -DBUILD_SERVER=$BUILD_SERVER

      - name: Build Windows (32-bit)
        run: cmake --build build-win32 --parallel

      #########################################
      # ARTIFACTS
      #########################################
      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux32-build
          path: build-linux32/

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: win32-build
          path: build-win32/
