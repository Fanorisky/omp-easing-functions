name: Build Release Artifacts

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CONFIG: Release
  BUILD_SERVER: "1"

jobs:

  linux-docker:
    name: Build Linux .so (Docker 32-bit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare build folder (uid 1000 required by container)
        run: |
          mkdir -p docker/build
          sudo chown 1000:1000 docker/build

      - name: Build Docker image
        run: |
          docker build -t omp-easing-functions/build:ubuntu-18.04 docker/build_ubuntu-18.04/

      - name: Run build in Docker container
        env:
          CONFIG: ${{ env.CONFIG }}
          BUILD_SERVER: ${{ env.BUILD_SERVER }}
        run: |
          docker run --rm -t \
            -w /code \
            -v "${{ github.workspace }}:/code" \
            -v "${{ github.workspace }}/docker/build:/code/build" \
            -e CONFIG=${CONFIG} \
            -e BUILD_SERVER=${BUILD_SERVER} \
            omp-easing-functions/build:ubuntu-18.04

      - name: Upload Linux .so artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-so
          path: |
            docker/build/**/*.so
            docker/build/*.so

  windows-cross:
    name: Build Windows .dll (MinGW 32-bit)
    runs-on: ubuntu-latest
    # Hapus komentar di bawah jika ingin paralel dengan linux-docker
    # needs: linux-docker  # Opsional, hanya jika Windows build memerlukan output dari Linux

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install MinGW 32-bit toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            g++-mingw-w64-i686 \
            gcc-mingw-w64-i686 \
            binutils-mingw-w64-i686 \
            mingw-w64-common \
            mingw-w64-i686-dev \
            ninja-build \
            cmake \
            build-essential

      - name: Verify MinGW installation
        run: |
          echo "=== Checking MinGW compilers ==="
          i686-w64-mingw32-gcc --version || echo "Warning: gcc not found"
          i686-w64-mingw32-g++ --version || echo "Warning: g++ not found"
          i686-w64-mingw32-windres --version || echo "Warning: windres not found"

      - name: Configure Windows 32-bit build
        run: |
          echo "=== Configuring for Windows 32-bit ==="
          
          # Configure CMake dengan flag untuk disable NEON dan enable SSE2
          cmake -S . -B build-win32 \
            -G Ninja \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=i686-w64-mingw32-gcc \
            -DCMAKE_CXX_COMPILER=i686-w64-mingw32-g++ \
            -DCMAKE_RC_COMPILER=i686-w64-mingw32-windres \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-UGLM_FORCE_NEON -DGLM_FORCE_SSE2 -m32 -msse2 -mfpmath=sse" \
            -DCMAKE_C_FLAGS="-UGLM_FORCE_NEON -m32 -msse2 -mfpmath=sse" \
            -DCMAKE_SHARED_LINKER_FLAGS="-static-libgcc -static-libstdc++ -m32" \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++ -m32"

      - name: Build Windows 32-bit DLL
        run: |
          echo "=== Building Windows DLL ==="
          
          # Build dengan parallel jobs
          cmake --build build-win32 --config Release --parallel $(nproc)
          
          echo "=== Build completed ==="
          
          # List all generated files
          echo "Generated files:"
          find build-win32 -name "*.dll" -o -name "*.exe" | while read f; do
            echo "- $f"
            file "$f" || true
          done

      - name: Upload Windows 32-bit .dll artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-dll-32bit
          path: |
            build-win32/**/*.dll
            build-win32/*.dll
          if-no-files-found: error
